#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-push checks: backend tests, frontend typecheck and lint"

printf "\n➡️  Backend: running cargo test --all-features\n"
if [ -d backend ]; then
  (cd backend && cargo test --all-features) || {
    echo "\n❌ Backend tests failed. Aborting push." >&2
    exit 1
  }
else
  echo "Backend folder not found, skipping backend tests"
fi

printf "\n➡️  Frontend: running TypeScript check and ESLint\n"
if [ -d frontend ]; then
  if [ -d frontend/node_modules ]; then
    # Run checks from within frontend dir to ensure tsc picks up the correct tsconfig
    if ! (cd frontend && npx --no-install tsc --noEmit); then
      echo "\n❌ Frontend typecheck failed. Aborting push." >&2
      exit 1
    fi

    # Lint
    if ! (cd frontend && npm run lint); then
      echo "\n❌ Frontend lint failed. Aborting push." >&2
      exit 1
    fi
  else
    echo "\n⚠️  frontend/node_modules not present — skipping frontend checks. To run them locally, install dev deps: 'cd frontend && npm ci'"
  fi
else
  echo "Frontend folder not found, skipping frontend checks"
fi

echo "\n✅ All pre-push checks passed"
