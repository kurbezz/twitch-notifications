#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-commit checks..."

# Frontend: lint-staged (prettier + eslint)
printf "\n➡️  Frontend: running lint-staged\n"
npx --no-install --prefix frontend lint-staged || {
  echo "\n❌ Frontend lint-staged failed. Aborting commit." >&2
  exit 1
}

# Backend: format check, format, and clippy
if [ -d backend ]; then
  # First, check if code is already formatted
  printf "\n➡️  Backend: checking formatting\n"
  if ! (cd backend && cargo fmt --all -- --check); then
    echo "\n⚠️  Backend code is not formatted. Formatting automatically..."
    # Format the code automatically
    (cd backend && cargo fmt --all) || {
      echo "\n❌ Backend formatting failed." >&2
      exit 1
    }
    # Add any formatted Rust files back to staging
    # Find all modified .rs files in backend directory and add them
    git diff --name-only --diff-filter=ACM | grep '^backend/.*\.rs$' | while read -r file; do
      git add "$file" 2>/dev/null || true
    done
    # Also add any unstaged .rs files that were modified by formatter
    git diff --name-only | grep '^backend/.*\.rs$' | while read -r file; do
      git add "$file" 2>/dev/null || true
    done
    # Verify formatting again (should pass after formatting)
    printf "\n➡️  Backend: verifying formatting after auto-format\n"
    if ! (cd backend && cargo fmt --all -- --check); then
      echo "\n❌ Backend formatting check failed even after formatting. Please check manually." >&2
      exit 1
    fi
  else
    echo "✅ Backend code is already formatted"
  fi

  # Backend: clippy
  printf "\n➡️  Backend: running clippy\n"
  if ! (cd backend && cargo clippy --all-targets --all-features -- -D warnings); then
    echo "\n❌ Backend clippy failed. Aborting commit." >&2
    exit 1
  fi
else
  echo "Backend folder not found, skipping backend checks"
fi

echo "\n✅ All pre-commit checks passed"
